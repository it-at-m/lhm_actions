name: "Advanced CodeQL action"
description: "Scans a repository using provided CodeQL language, buildmode and query scan set"

inputs:
  codeql-language:
    # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning#changing-the-languages-that-are-analyzed
    description: "CodeQL language name to scan with (e.g java-kotlin, javascript-typescript, python, ...)"
    required: true
  codeql-buildmode:
    # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages#codeql-build-modes
    description: "Build mode to use when scanning the source code (e.g. none, autobuild, manual)"
    required: false
    default: "none"
  codeql-query:
    # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning#using-queries-in-ql-packs
    description: "Query set to use when analyzing the source code (e.g. default, security-extended, security-and-quality)"
    required: false
    default: "security-and-quality"
  java-version:
    description: "Temurin JDK version to use for autobuild (only when codeql-language is java-kotlin and codeql-build is set to autobuild)"
    required: false
    default: "21"
  path:
    description: "Path to scan files in"
    required: false
    default: "."

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: Set up JDK
      if: inputs.codeql-language == 'java-kotlin' && inputs.codeql-buildmode == 'autobuild'
      uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
      with:
        java-version: ${{ inputs.java-version }}
        distribution: "temurin"
        cache: "maven"
        cache-dependency-path: "${{ inputs.path }}/pom.xml"
    - name: Initialize CodeQL for ${{ inputs.codeql-language }}
      uses: github/codeql-action/init@4bdb89f48054571735e3792627da6195c57459e2 # v3.31.10
      with:
        languages: ${{ inputs.codeql-language }}
        build-mode: ${{ inputs.codeql-buildmode }}
        queries: ${{ inputs.codeql-query }}
    - if: inputs.codeql-buildmode == 'autobuild'
      name: Build using autobuild
      uses: github/codeql-action/autobuild@4bdb89f48054571735e3792627da6195c57459e2 # v3.31.10
      with:
        working-directory: ${{ inputs.path }}
    - name: Perform CodeQL analysis for ${{ inputs.codeql-language }}
      uses: github/codeql-action/analyze@4bdb89f48054571735e3792627da6195c57459e2 # v3.31.10
      with:
        category: "/language:${{ inputs.codeql-language }}-/path:${{ inputs.path }}"
